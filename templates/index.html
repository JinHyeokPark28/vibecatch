<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCatch</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <!-- Plausible Analytics -->
    <script async src="https://plausible.io/js/pa-yF1y6vnV6--zn7mcfRQzu.js"></script>
    <script>window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};plausible.init()</script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">트렌드 수집 중...</div>
        <div class="loading-status" id="loadingStatus">HN, Reddit, GitHub에서 최신 트렌드를 가져오고 있습니다</div>
        <div class="loading-progress">
            <div class="loading-step" id="step-hn">
                <span class="loading-step-icon">○</span>
                <span>Hacker News</span>
            </div>
            <div class="loading-step" id="step-reddit">
                <span class="loading-step-icon">○</span>
                <span>Reddit</span>
            </div>
            <div class="loading-step" id="step-github">
                <span class="loading-step-icon">○</span>
                <span>GitHub</span>
            </div>
            <div class="loading-step" id="step-ai">
                <span class="loading-step-icon">○</span>
                <span>AI 요약</span>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1>VibeCatch</h1>
            <p class="subtitle">{{ total_count }}개 리뷰 대기</p>
            <button class="btn btn-collect" onclick="collectItems()">새로 수집</button>
            <nav class="nav">
                <a href="/" class="nav-link active">리뷰</a>
                <a href="/liked" class="nav-link">좋아요</a>
                <a href="/stats" class="nav-link">통계</a>
            </nav>
        </header>

        {% if items %}
        <div class="card-list">
            {% for item in items %}
            <article class="card" data-id="{{ item.id }}">
                <div class="card-source">
                    <span class="source-badge source-{{ item.source }}">{{ item.source | upper }}</span>
                    <time class="card-time">{{ item.collected_at[:10] }}</time>
                </div>

                <h2 class="card-title">
                    <a href="#" onclick="toggleCard({{ item.id }}, event)">{{ item.title_ko or item.title }}</a>
                </h2>

                <!-- Expanded Content (hidden by default) -->
                <div class="card-expanded" id="expanded-{{ item.id }}" style="display: none;">
                    <div class="expanded-loading">로딩 중...</div>
                    <div class="expanded-content"></div>
                    {% if item.url %}
                    <a href="{{ item.url }}" target="_blank" rel="noopener" class="expanded-link">
                        원문 보기 →
                    </a>
                    {% endif %}
                </div>

                {% if item.title_ko %}
                <p class="card-original-title">{{ item.title }}</p>
                {% endif %}

                <div class="card-actions">
                    <button class="btn btn-skip" onclick="reviewItem({{ item.id }}, 'skip')">
                        건너뛰기
                    </button>
                    <button class="btn btn-like" onclick="reviewItem({{ item.id }}, 'like')">
                        좋아요
                    </button>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>리뷰할 항목이 없습니다</p>
            <p class="empty-hint"><code>POST /collect</code>로 새 항목을 수집하세요</p>
        </div>
        {% endif %}
    </div>

    <script>
        async function toggleCard(id, event) {
            event.preventDefault();
            const expandedDiv = document.getElementById(`expanded-${id}`);
            const card = document.querySelector(`[data-id="${id}"]`);

            if (expandedDiv.style.display === 'none') {
                // Expand
                expandedDiv.style.display = 'block';
                card.classList.add('card-expanded-state');

                // Fetch content if not loaded
                const contentDiv = expandedDiv.querySelector('.expanded-content');
                const loadingDiv = expandedDiv.querySelector('.expanded-loading');

                if (!contentDiv.innerHTML) {
                    try {
                        const response = await fetch(`/item/${id}`);
                        const data = await response.json();

                        if (data.success) {
                            loadingDiv.style.display = 'none';
                            let html = '';

                            if (data.item.summary) {
                                html += `<p class="expanded-summary">${data.item.summary}</p>`;
                            }

                            if (data.item.tags && data.item.tags.length > 0) {
                                html += '<div class="expanded-tags">';
                                data.item.tags.forEach(tag => {
                                    html += `<span class="tag">${tag}</span>`;
                                });
                                html += '</div>';
                            }

                            if (!html) {
                                html = '<p class="expanded-empty">추가 정보가 없습니다.</p>';
                            }

                            contentDiv.innerHTML = html;
                        } else {
                            loadingDiv.textContent = '로드 실패';
                        }
                    } catch (error) {
                        console.error('Error fetching item:', error);
                        loadingDiv.textContent = '로드 실패';
                    }
                } else {
                    loadingDiv.style.display = 'none';
                }
            } else {
                // Collapse
                expandedDiv.style.display = 'none';
                card.classList.remove('card-expanded-state');
            }
        }

        async function reviewItem(id, action) {
            try {
                const response = await fetch(`/review/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action }),
                });

                if (response.ok) {
                    // Remove card from UI
                    const card = document.querySelector(`[data-id="${id}"]`);
                    if (card) {
                        card.classList.add('card-exit');
                        setTimeout(() => card.remove(), 300);
                    }

                    // Update count
                    updateCount();
                } else {
                    console.error('Review failed:', await response.text());
                }
            } catch (error) {
                console.error('Review error:', error);
            }
        }

        function updateCount() {
            const cards = document.querySelectorAll('.card');
            const subtitle = document.querySelector('.subtitle');
            if (subtitle) {
                subtitle.textContent = `${cards.length}개 리뷰 대기`;
            }
        }

        async function collectItems() {
            const btn = document.querySelector('.btn-collect');
            const overlay = document.getElementById('loadingOverlay');
            const status = document.getElementById('loadingStatus');

            btn.disabled = true;
            overlay.classList.add('active');

            // Animate steps
            const steps = ['hn', 'reddit', 'github', 'ai'];
            let currentStep = 0;

            function updateStep(stepId, state) {
                const step = document.getElementById(`step-${stepId}`);
                const icon = step.querySelector('.loading-step-icon');
                step.classList.remove('active', 'done');

                if (state === 'active') {
                    step.classList.add('active');
                    icon.textContent = '◐';
                } else if (state === 'done') {
                    step.classList.add('done');
                    icon.textContent = '✓';
                } else {
                    icon.textContent = '○';
                }
            }

            // Simulate progress while waiting
            const progressInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    if (currentStep > 0) {
                        updateStep(steps[currentStep - 1], 'done');
                    }
                    updateStep(steps[currentStep], 'active');

                    const messages = [
                        'Hacker News에서 인기 글 수집 중...',
                        'Reddit 서브레딧 탐색 중...',
                        'GitHub 트렌딩 레포 검색 중...',
                        'Claude가 요약 생성 중...'
                    ];
                    status.textContent = messages[currentStep];
                    currentStep++;
                }
            }, 2000);

            try {
                const response = await fetch('/collect', {
                    method: 'POST',
                });

                clearInterval(progressInterval);

                // Mark all as done
                steps.forEach(s => updateStep(s, 'done'));
                status.textContent = '완료! 페이지를 새로고침합니다...';

                if (response.ok) {
                    const data = await response.json();
                    const total = data.collected.hn.inserted + data.collected.reddit.inserted + data.collected.github.inserted;
                    status.textContent = `${total}개 새 항목 추가, ${data.summarized.summarized}개 요약 완료!`;

                    setTimeout(() => location.reload(), 1500);
                } else {
                    status.textContent = '수집 실패 - 다시 시도해주세요';
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                clearInterval(progressInterval);
                console.error('Collect error:', error);
                status.textContent = '오류 발생 - 다시 시도해주세요';
                setTimeout(() => {
                    overlay.classList.remove('active');
                    btn.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>
