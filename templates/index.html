<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCatch</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>VibeCatch</h1>
            <p class="subtitle">{{ total_count }}개 리뷰 대기</p>
            <button class="btn btn-collect" onclick="collectItems()">새로 수집</button>
        </header>

        {% if items %}
        <div class="card-list">
            {% for item in items %}
            <article class="card" data-id="{{ item.id }}">
                <div class="card-source">
                    <span class="source-badge source-{{ item.source }}">{{ item.source | upper }}</span>
                    <time class="card-time">{{ item.collected_at[:10] }}</time>
                </div>

                <h2 class="card-title">
                    <a href="#" onclick="toggleCard({{ item.id }}, event)">{{ item.title_ko or item.title }}</a>
                </h2>

                <!-- Expanded Content (hidden by default) -->
                <div class="card-expanded" id="expanded-{{ item.id }}" style="display: none;">
                    <div class="expanded-loading">로딩 중...</div>
                    <div class="expanded-content"></div>
                    {% if item.url %}
                    <a href="{{ item.url }}" target="_blank" rel="noopener" class="expanded-link">
                        원문 보기 →
                    </a>
                    {% endif %}
                </div>

                {% if item.title_ko %}
                <p class="card-original-title">{{ item.title }}</p>
                {% endif %}

                {% if item.summary %}
                <p class="card-summary">{{ item.summary }}</p>
                {% endif %}

                {% if item.tags %}
                <div class="card-tags">
                    {% for tag in item.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="card-actions">
                    <button class="btn btn-skip" onclick="reviewItem({{ item.id }}, 'skip')">
                        건너뛰기
                    </button>
                    <button class="btn btn-like" onclick="reviewItem({{ item.id }}, 'like')">
                        좋아요
                    </button>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>리뷰할 항목이 없습니다</p>
            <p class="empty-hint"><code>POST /collect</code>로 새 항목을 수집하세요</p>
        </div>
        {% endif %}
    </div>

    <script>
        async function toggleCard(id, event) {
            event.preventDefault();
            const expandedDiv = document.getElementById(`expanded-${id}`);
            const card = document.querySelector(`[data-id="${id}"]`);

            if (expandedDiv.style.display === 'none') {
                // Expand
                expandedDiv.style.display = 'block';
                card.classList.add('card-expanded-state');

                // Fetch content if not loaded
                const contentDiv = expandedDiv.querySelector('.expanded-content');
                const loadingDiv = expandedDiv.querySelector('.expanded-loading');

                if (!contentDiv.innerHTML) {
                    try {
                        const response = await fetch(`/item/${id}`);
                        const data = await response.json();

                        if (data.success) {
                            loadingDiv.style.display = 'none';
                            let html = '';

                            if (data.item.summary) {
                                html += `<p class="expanded-summary">${data.item.summary}</p>`;
                            }

                            if (data.item.tags && data.item.tags.length > 0) {
                                html += '<div class="expanded-tags">';
                                data.item.tags.forEach(tag => {
                                    html += `<span class="tag">${tag}</span>`;
                                });
                                html += '</div>';
                            }

                            if (!html) {
                                html = '<p class="expanded-empty">추가 정보가 없습니다.</p>';
                            }

                            contentDiv.innerHTML = html;
                        } else {
                            loadingDiv.textContent = '로드 실패';
                        }
                    } catch (error) {
                        console.error('Error fetching item:', error);
                        loadingDiv.textContent = '로드 실패';
                    }
                } else {
                    loadingDiv.style.display = 'none';
                }
            } else {
                // Collapse
                expandedDiv.style.display = 'none';
                card.classList.remove('card-expanded-state');
            }
        }

        async function reviewItem(id, action) {
            try {
                const response = await fetch(`/review/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action }),
                });

                if (response.ok) {
                    // Remove card from UI
                    const card = document.querySelector(`[data-id="${id}"]`);
                    if (card) {
                        card.classList.add('card-exit');
                        setTimeout(() => card.remove(), 300);
                    }

                    // Update count
                    updateCount();
                } else {
                    console.error('Review failed:', await response.text());
                }
            } catch (error) {
                console.error('Review error:', error);
            }
        }

        function updateCount() {
            const cards = document.querySelectorAll('.card');
            const subtitle = document.querySelector('.subtitle');
            if (subtitle) {
                subtitle.textContent = `${cards.length}개 리뷰 대기`;
            }
        }

        async function collectItems() {
            const btn = document.querySelector('.btn-collect');
            btn.disabled = true;
            btn.textContent = '수집 중...';

            try {
                const response = await fetch('/collect', {
                    method: 'POST',
                });

                if (response.ok) {
                    const data = await response.json();
                    const hn = data.collected.hn;
                    const reddit = data.collected.reddit;
                    alert(`수집 완료!\nHN: ${hn.inserted}개 추가\nReddit: ${reddit.inserted}개 추가\n요약: ${data.summarized.summarized}개`);
                    location.reload();
                } else {
                    alert('수집 실패');
                }
            } catch (error) {
                console.error('Collect error:', error);
                alert('수집 중 오류 발생');
            } finally {
                btn.disabled = false;
                btn.textContent = '새로 수집';
            }
        }
    </script>
</body>
</html>
