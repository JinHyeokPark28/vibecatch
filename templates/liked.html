<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCatch - Liked</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>VibeCatch</h1>
            <p class="subtitle">{{ total_count }}개 좋아요</p>
            <nav class="nav">
                <a href="/" class="nav-link">리뷰</a>
                <a href="/liked" class="nav-link active">좋아요</a>
            </nav>
        </header>

        {% if items %}
        <div class="card-list">
            {% for item in items %}
            <article class="card" data-id="{{ item.id }}">
                <div class="card-source">
                    <span class="source-badge source-{{ item.source }}">{{ item.source | upper }}</span>
                    <time class="card-time">{{ item.collected_at[:10] }}</time>
                </div>

                <h2 class="card-title">
                    <a href="#" onclick="toggleCard({{ item.id }}, event)">{{ item.title_ko or item.title }}</a>
                </h2>

                <!-- Expanded Content (hidden by default) -->
                <div class="card-expanded" id="expanded-{{ item.id }}" style="display: none;">
                    <div class="expanded-loading">로딩 중...</div>
                    <div class="expanded-content"></div>
                    {% if item.url %}
                    <a href="{{ item.url }}" target="_blank" rel="noopener" class="expanded-link">
                        원문 보기 →
                    </a>
                    {% endif %}
                </div>

                {% if item.title_ko %}
                <p class="card-original-title">{{ item.title }}</p>
                {% endif %}

                {% if item.reviewed_at %}
                <p class="card-reviewed">{{ item.reviewed_at[:10] }} 좋아요</p>
                {% endif %}

                <div class="card-actions">
                    <button class="btn btn-unlike" onclick="unlikeItem({{ item.id }})">
                        좋아요 취소
                    </button>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>좋아요한 항목이 없습니다</p>
            <p class="empty-hint"><a href="/">리뷰 페이지</a>에서 좋아요를 눌러보세요</p>
        </div>
        {% endif %}
    </div>

    <script>
        async function unlikeItem(id) {
            if (!confirm('좋아요를 취소하시겠습니까?')) return;

            try {
                const response = await fetch(`/review/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'skip' }),
                });

                if (response.ok) {
                    const card = document.querySelector(`[data-id="${id}"]`);
                    if (card) {
                        card.classList.add('card-exit');
                        setTimeout(() => {
                            card.remove();
                            updateCount();
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('Unlike error:', error);
            }
        }

        function updateCount() {
            const cards = document.querySelectorAll('.card');
            const subtitle = document.querySelector('.subtitle');
            if (subtitle) {
                subtitle.textContent = `${cards.length}개 좋아요`;
            }
        }

        async function toggleCard(id, event) {
            event.preventDefault();
            const expandedDiv = document.getElementById(`expanded-${id}`);
            const card = document.querySelector(`[data-id="${id}"]`);

            if (expandedDiv.style.display === 'none') {
                // Expand
                expandedDiv.style.display = 'block';
                card.classList.add('card-expanded-state');

                // Fetch content if not loaded
                const contentDiv = expandedDiv.querySelector('.expanded-content');
                const loadingDiv = expandedDiv.querySelector('.expanded-loading');

                if (!contentDiv.innerHTML) {
                    try {
                        const response = await fetch(`/item/${id}`);
                        const data = await response.json();

                        if (data.success) {
                            loadingDiv.style.display = 'none';
                            let html = '';

                            if (data.item.summary) {
                                html += `<p class="expanded-summary">${data.item.summary}</p>`;
                            }

                            if (data.item.tags && data.item.tags.length > 0) {
                                html += '<div class="expanded-tags">';
                                data.item.tags.forEach(tag => {
                                    html += `<span class="tag">${tag}</span>`;
                                });
                                html += '</div>';
                            }

                            if (!html) {
                                html = '<p class="expanded-empty">추가 정보가 없습니다.</p>';
                            }

                            contentDiv.innerHTML = html;
                        } else {
                            loadingDiv.textContent = '로드 실패';
                        }
                    } catch (error) {
                        console.error('Error fetching item:', error);
                        loadingDiv.textContent = '로드 실패';
                    }
                } else {
                    loadingDiv.style.display = 'none';
                }
            } else {
                // Collapse
                expandedDiv.style.display = 'none';
                card.classList.remove('card-expanded-state');
            }
        }
    </script>
</body>
</html>
