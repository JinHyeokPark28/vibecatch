<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeCatch - For You</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <!-- Plausible Analytics -->
    <script async src="https://plausible.io/js/pa-yF1y6vnV6--zn7mcfRQzu.js"></script>
    <script>window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};plausible.init()</script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>VibeCatch</h1>
            <p class="subtitle">{{ total_count }}개 추천</p>
            <nav class="nav">
                <a href="/" class="nav-link">리뷰</a>
                <a href="/foryou" class="nav-link active">For You</a>
                <a href="/liked" class="nav-link">좋아요</a>
                <a href="/stats" class="nav-link">통계</a>
            </nav>
        </header>

        {% if not has_preferences %}
        <div class="empty-state">
            <p>아직 선호도 데이터가 없습니다</p>
            <p class="empty-hint"><a href="/">리뷰 페이지</a>에서 좋아요를 눌러 취향을 학습시켜주세요</p>
        </div>
        {% elif items %}
        <div class="magazine-layout">
            <!-- Featured Section (Top Recommendation) -->
            {% if items|length > 0 %}
            <section class="featured-section">
                <div class="featured-label">Top Pick</div>
                {% set item = items[0] %}
                <article class="card card-featured" data-id="{{ item.id }}" data-source="{{ item.source }}">
                    <div class="card-source">
                        <span class="source-badge source-{{ item.source }}">{{ item.source | upper }}</span>
                        <span class="preference-score">+{{ item.preference_score }}</span>
                        <time class="card-time">{{ item.collected_at[:10] }}</time>
                    </div>

                    <h2 class="card-title">
                        <a href="#" onclick="toggleCard({{ item.id }}, event)">{{ item.title_ko or item.title }}</a>
                    </h2>

                    {% if item.title_ko %}
                    <p class="card-original-title">{{ item.title }}</p>
                    {% endif %}

                    <p class="card-summary">{{ item.summary[:200] + '...' if item.summary and item.summary|length > 200 else item.summary or '' }}</p>

                    <!-- Expanded Content (hidden by default) -->
                    <div class="card-expanded" id="expanded-{{ item.id }}" style="display: none;">
                        <div class="expanded-loading">로딩 중...</div>
                        <div class="expanded-content"></div>
                        {% if item.url %}
                        <a href="{{ item.url }}" target="_blank" rel="noopener" class="expanded-link">
                            원문 보기 →
                        </a>
                        {% endif %}
                    </div>

                    <div class="card-actions">
                        <button class="btn btn-skip" onclick="reviewItem({{ item.id }}, 'skip')">
                            건너뛰기
                        </button>
                        <button class="btn btn-like" onclick="reviewItem({{ item.id }}, 'like')">
                            좋아요
                        </button>
                    </div>
                </article>
            </section>
            {% endif %}

            <!-- Grid Section (More Recommendations) -->
            {% if items|length > 1 %}
            <section class="grid-section">
                <div class="grid-label">More For You</div>
                <div class="card-grid">
                    {% for item in items[1:] %}
                    <article class="card card-compact" data-id="{{ item.id }}" data-source="{{ item.source }}">
                        <div class="card-source">
                            <span class="source-badge source-{{ item.source }}">{{ item.source | upper }}</span>
                            <span class="preference-score">+{{ item.preference_score }}</span>
                            <time class="card-time">{{ item.collected_at[:10] }}</time>
                        </div>

                        <h2 class="card-title">
                            <a href="#" onclick="toggleCard({{ item.id }}, event)">{{ item.title_ko or item.title }}</a>
                        </h2>

                        <!-- Expanded Content (hidden by default) -->
                        <div class="card-expanded" id="expanded-{{ item.id }}" style="display: none;">
                            <div class="expanded-loading">로딩 중...</div>
                            <div class="expanded-content"></div>
                            {% if item.url %}
                            <a href="{{ item.url }}" target="_blank" rel="noopener" class="expanded-link">
                                원문 보기 →
                            </a>
                            {% endif %}
                        </div>

                        <div class="card-actions">
                            <button class="btn btn-skip" onclick="reviewItem({{ item.id }}, 'skip')">
                                건너뛰기
                            </button>
                            <button class="btn btn-like" onclick="reviewItem({{ item.id }}, 'like')">
                                좋아요
                            </button>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>맞춤 추천 항목이 없습니다</p>
            <p class="empty-hint">더 많은 항목을 리뷰하면 추천이 정확해집니다</p>
        </div>
        {% endif %}
    </div>

    <script>
        async function toggleCard(id, event) {
            event.preventDefault();
            const expandedDiv = document.getElementById(`expanded-${id}`);
            const card = document.querySelector(`[data-id="${id}"]`);

            if (expandedDiv.style.display === 'none') {
                expandedDiv.style.display = 'block';
                card.classList.add('card-expanded-state');

                const contentDiv = expandedDiv.querySelector('.expanded-content');
                const loadingDiv = expandedDiv.querySelector('.expanded-loading');

                if (!contentDiv.innerHTML) {
                    try {
                        const response = await fetch(`/item/${id}`);
                        const data = await response.json();

                        if (data.success) {
                            loadingDiv.style.display = 'none';
                            let html = '';

                            if (data.item.summary) {
                                html += `<p class="expanded-summary">${data.item.summary}</p>`;
                            }

                            if (data.item.tags && data.item.tags.length > 0) {
                                html += '<div class="expanded-tags">';
                                data.item.tags.forEach(tag => {
                                    html += `<span class="tag">${tag}</span>`;
                                });
                                html += '</div>';
                            }

                            if (!html) {
                                html = '<p class="expanded-empty">추가 정보가 없습니다.</p>';
                            }

                            contentDiv.innerHTML = html;
                        } else {
                            loadingDiv.textContent = '로드 실패';
                        }
                    } catch (error) {
                        console.error('Error fetching item:', error);
                        loadingDiv.textContent = '로드 실패';
                    }
                } else {
                    loadingDiv.style.display = 'none';
                }
            } else {
                expandedDiv.style.display = 'none';
                card.classList.remove('card-expanded-state');
            }
        }

        async function reviewItem(id, action) {
            try {
                const response = await fetch(`/review/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action }),
                });

                if (response.ok) {
                    const card = document.querySelector(`[data-id="${id}"]`);
                    if (card) {
                        card.classList.add('card-exit');
                        setTimeout(() => card.remove(), 300);
                    }
                    updateCount();
                } else {
                    console.error('Review failed:', await response.text());
                }
            } catch (error) {
                console.error('Review error:', error);
            }
        }

        function updateCount() {
            const cards = document.querySelectorAll('.card');
            const subtitle = document.querySelector('.subtitle');
            if (subtitle) {
                subtitle.textContent = `${cards.length}개 추천`;
            }
        }
    </script>
</body>
</html>
